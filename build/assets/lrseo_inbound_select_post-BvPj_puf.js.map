{"version":3,"file":"lrseo_inbound_select_post-BvPj_puf.js","sources":["../../src/js/admin.ajax.inbound_select_post.js"],"sourcesContent":["import \"./admin.cache\"\nimport {checkLrseoAdminPage} from \"./admin.check_lrseo_page\";\nimport {Store} from \"./admin.cache\";\n\njQuery(document).ready(function ($) {\n\n    // On vérifie qu'on est sur la page adu plugin\n    if (!checkLrseoAdminPage()) {\n        return;\n    }\n\n\n    const mainBtn = $('#inbound_select_post')\n\n    mainBtn.on('click', function (e) {\n        e.preventDefault();\n        let query = new URLSearchParams(window.location.search);\n        let post_id = query.get('lrseo_inbound_post_select');\n        const kw = $('#inbound_kw_post').val();\n        const title = $('tr[data-id=\"'+post_id+'\"]').data('title');\n        const allResults = [];\n\n        if (!kw) {\n            alert('Veuillez renseigner un mot-clé');\n            return;\n        }\n\n        mainBtn.attr('disabled', true);\n        mainBtn.text('Analyse des articles en cours...');\n\n        const storeResult = Store.get(`lrseo_inbound_select_post_${post_id}_${kw}`);\n        if (storeResult) {\n            allResults.push(...storeResult);\n            displayResults(allResults, post_id)\n            return;\n        }\n\n        // let liste = $('input[name=\"liste\"]').val();\n        // liste = atob(decodeURIComponent(liste));\n        // // On enlève de la liste le post sélectionné\n        // liste = liste.split('\\n').filter(post => {\n        //     const postObj = JSON.parse(post);\n        //     return parseInt(postObj.id, 10) !== parseInt(postId, 10);\n        // }).join('\\n');\n\n        // Change the url without navigate\n        // const url = new URL(window.location.href);\n        // url.searchParams.set('lrseo_inbound_post_select', postId);\n        // window.history.replaceState({}, '', url);\n\n        // On affiche la progress bar\n        const progressBar = $('#inbound_progress_bar');\n        const progressBarText = $('#inbound_progress_bar_text');\n        const bar = progressBar.find('.bar');\n        progressBar.removeClass('lr-hidden');\n        bar.attr('style', 'width: 0%;');\n\n        // On parcourt la liste et on envoie une requête avec a chaque fois 25 éléments\n        // On attend que chaque requête soit terminée pour passer a la suivante\n        // On met a jour la progress bar\n        // const listeToArr = liste.split('\\n');\n\n        // Nombre d'options du select\n        const total = $('#lrseo_allposts_tbody tr').length - 1;\n        const step = 30;\n        const promises = [];\n\n        progressBarText.text(`0/${total}`);\n\n        for (let i = 0; i < total; i += step) {\n            const data = {\n                action: 'lrseo_inbound_select_post',\n                kw: kw,\n                title: title,\n                post_id: post_id,\n                current: i,\n                step: step,\n                security: lrseo_inbound_select_post.nonce\n            };\n\n            promises.push(new Promise(async (resolve) => {\n                await new Promise(resolve => setTimeout(resolve, i * 50))\n                $.post(lrseo_inbound_select_post.url, data, (response) => {\n                    if (response.success) {\n                        allResults.push(...response.data);\n                        progressBarText.text(`${allResults.length}/${total}`);\n                        // Store.store(allResults, 'lrseo_inbound_select_post');\n                        bar.attr('style', `width: ${Math.round((allResults.length / total) * 100)}%;`);\n                    }\n                    resolve();\n                })\n            }))\n        }\n\n        Promise.all(promises).then(() => {\n            progressBar.addClass('lr-hidden');\n            Store.store(allResults, `lrseo_inbound_select_post_${post_id}_${kw}`, 60);\n            displayResults(allResults, post_id)\n        })\n    })\n\n    function displayResults(posts, postId) {\n        posts.sort((a, b) => b.score - a.score)\n        $('#inbound_table_results').removeClass('lr-hidden')\n        $('#inbound_results').removeClass('lr-hidden')\n        $('#inbound_src_post').val(postId);\n        mainBtn.attr('disabled', false);\n        mainBtn.text('Voir les articles sources potentiels');\n        const tbody = $('#inbound_tbody_results')\n        tbody.html('');\n        if (posts) {\n            const rows = posts.map(post =>\n                `<tr>\n                    <th scope=\"row\" class=\"check-column\"><input type=\"checkbox\" name=\"post[]\"} data-id=\"${post.id}\" data-title=\"${post.title}\"/></th>\n                    <td class=\"title has-row-actions column-title column-primary lr-max-w-[800px] lr-overflow-y-scroll\">\n                        <strong>${post.titre || post.title || ''}</strong>\n                        <div class=\"row-actions\">\n                            <span class=\"edit\"><a href=\"/wp-admin/post.php?post=${post.id}&action=edit\">Modifier</a> | </span>\n                            <span class=\"view\"><a href=\"/?p=${post.id}\" target=\"_blank\">Voir</a></span>\n                        </div>\n                    </td>\n                    <td>${post.score}</td>\n                    <td>${Intl.NumberFormat('fr-FR', {maximumFractionDigits: 2}).format(post.pct_links)}</td>\n                </tr>`\n            ).join('');\n\n            tbody.html(rows);\n        }\n    }\n});"],"names":["$","checkLrseoAdminPage","mainBtn","e","post_id","kw","title","allResults","storeResult","Store","displayResults","progressBar","progressBarText","bar","total","step","promises","i","data","resolve","response","posts","postId","a","b","tbody","rows","post"],"mappings":"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"}