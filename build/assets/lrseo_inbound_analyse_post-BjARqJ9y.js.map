{"version":3,"file":"lrseo_inbound_analyse_post-BjARqJ9y.js","sources":["../../src/js/admin.ajax.inbound_analyse_post.js"],"sourcesContent":["import {checkLrseoAdminPage} from \"./admin.check_lrseo_page\";\nimport {Store} from \"./admin.cache\";\n\njQuery(document).ready(function ($) {\n\n    // On vérifie qu'on est sur la page adu plugin\n    if (!checkLrseoAdminPage()) {\n        return;\n    }\n\n    const mainBtn = $('#inbound_submit_posts_link')\n    const progressBar = $('#inbound_progress_bar_posts_link');\n    const progressBarText = $('#inbound_progress_bar_posts_link_text');\n\n    mainBtn.on('click', function (e) {\n        e.preventDefault();\n        const checked = $('input[name=\"post[]\"]:checked');\n        const ids = [];\n        checked.each(function () {\n            ids.push($(this).data('id'));\n        });\n\n        if (ids.length === 0) {\n            return;\n        }\n\n        const kw = $('#inbound_kw_post').val();\n\n        if (!kw) {\n            alert('Veuillez renseigner un mot-clé');\n            return;\n        }\n\n        // On affiche la progress bar\n        const bar = progressBar.find('.bar');\n        progressBar.removeClass('lr-hidden');\n        bar.attr('style', 'width: 0%;');\n        progressBarText.text(`0/${ids.length}`);\n        mainBtn.attr('disabled', true);\n        mainBtn.text('Analyse des articles en cours...');\n\n        const promises = [];\n        const allResults = [];\n\n        for (let i = 0; i < ids.length; i++) {\n            const currentId = ids[i];\n            const data = {\n                action: 'lrseo_inbound_analyse_post',\n                post_id_dst: ids[i],\n                post_id_src: $('#inbound_src_post').val(),\n                kw: kw,\n                security: lrseo_inbound_analyse_post.nonce\n            };\n\n            if (Store.get(`lrseo_inbound_analyse_post_${currentId}`)) {\n                allResults.push(Store.get(`lrseo_inbound_analyse_post_${currentId}`));\n                progressBarText.text(`${allResults.length}/${ids.length}`);\n                bar.attr('style', `width: ${Math.round((allResults.length / ids.length) * 100)}%;`);\n                continue;\n            }\n\n            promises.push(new Promise((resolve) => {\n                setTimeout(() => {\n                    $.post(lrseo_inbound_analyse_post.url, data, (response) => {\n                        if (response.success) {\n                            allResults.push(response.data);\n                            progressBarText.text(`${allResults.length}/${ids.length}`);\n                            bar.attr('style', `width: ${Math.round((allResults.length / ids.length) * 100)}%;`);\n                        } else {\n                            console.error(response.data);\n                            // Tentative de nouvelle requête en cas d'échec\n                            $.post(lrseo_inbound_analyse_post.url, data, (retryResponse) => {\n                                if (retryResponse.success) {\n                                    allResults.push(retryResponse.data);\n                                    progressBarText.text(`${allResults.length}/${ids.length}`);\n                                    bar.attr('style', `width: ${Math.round((allResults.length / ids.length) * 100)}%;`);\n                                } else {\n                                    console.error(retryResponse.data);\n                                }\n                            });\n                        }\n                        resolve();\n                    });\n                }, i * 10000); // Délai de 10 secondes multiplié par l'index\n            }));\n        }\n\n        Promise.all(promises).then(() => {\n            progressBar.addClass('lr-hidden');\n            displayResults(allResults)\n        })\n\n    })\n\n    function displayResults(results) {\n        console.log('displayResults', results)\n        progressBar.addClass('lr-hidden');\n        mainBtn.attr('disabled', false);\n        mainBtn.text('Suggérer des liens');\n        progressBarText.text('');\n\n        const divResult = $(\"#inbound_posts_link_results\");\n        divResult.empty();\n\n        if (results.length === 0) {\n            divResult.append('<p>Aucun résultat</p>');\n            return;\n        }\n\n        let allHtml = '';\n        results.forEach((resultsArticle, index) => {\n\n            allHtml += `<div class=\"lr-p-6 lr-border-1 lr-mb-2 lr-border-dashed lr-border-gray-400 lr-bg-white\">\n                <h3 class=\"title\">Article source: ${resultsArticle[0].title_dst}</h3>`\n            resultsArticle.forEach((result, index2) => {\n                const before = new TextEncoder().encode(result.before)\n                const binString = Array.from(before, (byte) =>\n                    String.fromCodePoint(byte),\n                ).join(\"\");\n                const b64Before = btoa(binString)\n\n                const sentence = new TextEncoder().encode(result.sentence)\n                const binString2 = Array.from(sentence, (byte) =>\n                    String.fromCodePoint(byte),\n                ).join(\"\");\n                const b64Sentence = btoa(binString2)\n\n                allHtml += `<div class=\"lr-flex lr-flex-col lr-gap-2 lr-mb-2\">\n                    <div class=\"lr-flex lr-gap-2\">\n                        <div class=\"lr-self-center lr-w-1/6\">Texte avant: </div>\n                        <div class=\"lrse_copy_clipboard lr-cursor-pointer lr-underline\" data-html=\"${b64Before}\"><svg class=\"w-6 h-6 text-gray-800 dark:text-white\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" fill=\"none\" viewBox=\"0 0 24 24\">\n  <path stroke=\"currentColor\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 8v3a1 1 0 0 1-1 1H5m11 4h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-7a1 1 0 0 0-1 1v1m4 3v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-7.13a1 1 0 0 1 .24-.65L7.7 8.35A1 1 0 0 1 8.46 8H13a1 1 0 0 1 1 1Z\"/>\n</svg>\n</div>\n                        <div id=\"inbound_html_before_${index}_${index2}\">${result.before}</div>\n                    </div>\n                    <div class=\"lr-flex lr-gap-2\">\n                        <div class=\"lr-self-center lr-w-1/6\">Phrase du lien: </div>\n                        <div class=\"lrse_copy_clipboard lr-cursor-pointer lr-underline\" data-html=\"${b64Sentence}\"><svg class=\"w-6 h-6 text-gray-800 dark:text-white\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" fill=\"none\" viewBox=\"0 0 24 24\">\n  <path stroke=\"currentColor\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 8v3a1 1 0 0 1-1 1H5m11 4h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-7a1 1 0 0 0-1 1v1m4 3v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-7.13a1 1 0 0 1 .24-.65L7.7 8.35A1 1 0 0 1 8.46 8H13a1 1 0 0 1 1 1Z\"/>\n</svg>\n</div>\n                        <div id=\"inbound_html_sentence_${index}_${index2}\">${result.sentence}</div>\n                    </div>\n                    <a type=\"button\" href=\"/wp-admin/post.php?post=${result.id_dst}&action=edit\" target=\"_blank\" id=\"inbound_edit_article_${index}_${index2}\" class=\"lr-max-w-[300px] button button-secondary\">Aller sur la modification de l'article</a>\n                </div>\n                <hr />`;\n            })\n\n            allHtml += '</div>'\n        })\n\n\n        divResult.append(allHtml)\n\n        $('.lrse_copy_clipboard').on('click', function () {\n            const b64 = atob($(this).data('html'))\n            const arrayStr = Uint8Array.from(b64, (m) => m.codePointAt(0));\n            const html = new TextDecoder().decode(arrayStr)\n\n            const type = \"text/html\";\n            const blob = new Blob([html], { type });\n            const data = [new ClipboardItem({ [type]: blob })];\n            navigator.clipboard.write(data).then(function () {\n                console.log('Copied to clipboard')\n            }).catch(function (error) {\n                console.error('Copy failed', error);\n            });\n\n        })\n    }\n\n})"],"names":["$","checkLrseoAdminPage","mainBtn","progressBar","progressBarText","e","checked","ids","kw","bar","promises","allResults","i","currentId","data","Store","resolve","response","retryResponse","displayResults","results","divResult","allHtml","resultsArticle","index","result","index2","before","binString","byte","b64Before","sentence","binString2","b64Sentence","b64","arrayStr","m","html","type","blob","error"],"mappings":"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"}